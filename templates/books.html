{% extends "layout.html" %}

{% block content %}
<div class="row mb-4 align-items-center">
    <div class="col-md-6">
        <h2 class="page-title">üìö Inventory</h2>
    </div>
    <div class="col-md-6 text-end">
        <a href="/add_book" class="btn btn-success me-2">+ Add Book</a>
        <a href="/issue" class="btn btn-primary">+ Issue Book</a>
    </div>
</div>

<div class="card p-3 mb-4">
    <div class="row g-3">
        <div class="col-md-5">
            <input type="text" id="searchInput" class="form-control" placeholder="üîç Search Title, Author, ID...">
        </div>
        <div class="col-md-3">
            <select id="departmentFilter" class="form-select">
                <option value="">All Departments</option>
                <option value="Computer Science">Computer Science</option>
                <option value="Mechanical">Mechanical</option>
                <option value="Civil">Civil</option>
                <option value="Electronics">Electronics</option>
                <option value="MBA">MBA</option>
            </select>
        </div>
        <div class="col-md-4">
            <select id="statusFilter" class="form-select">
                <option value="">All Statuses</option>
                <option value="Available">üü¢ Available</option>
                <option value="Issued">üî¥ Issued</option>
            </select>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover" id="booksTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Title</th>
                        <th>Author</th>
                        <th>Department</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for book in books %}
                    <tr class="book-row" data-dept="{{ book.Department }}" data-status="{{ book.Status }}">
                        <td><code>{{ book.BookID }}</code></td>
                        <td class="book-title">{{ book.Title }}</td>
                        <td class="book-author">{{ book.Author }}</td>
                        <td><span class="badge bg-light text-dark border">{{ book.Department }}</span></td>
                        <td>
                            {% if book.Status == 'Issued' %}
                            <span class="badge bg-warning text-dark">Issued</span>
                            {% else %}
                            <span class="badge bg-success">Available</span>
                            {% endif %}
                        </td>
                        <td>
                            <a href="/issue?book_id={{ book.BookID }}" class="btn btn-sm btn-outline-primary">Issue</a>
                            <a href="/delete/book/{{ book.BookID }}" class="btn btn-sm btn-outline-danger"
                                onclick="return confirm('Are you sure you want to delete this book? This cannot be undone.');">Del</a>
                        </td>
                    </tr>
                    {% endfor %}
                    <tr id="noResults" style="display: none;">
                        <td colspan="6" class="text-center text-muted py-4">No books found matching your criteria.</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div class="d-flex justify-content-between align-items-center mt-3">
            <div>
                {% if has_prev %}
                <a href="{{ url_for('books_page', page=page-1, status=filter) }}"
                    class="btn btn-sm btn-outline-secondary">‚Üê Previous</a>
                {% endif %}
            </div>
            <span class="text-muted">Page {{ page }}</span>
            <div>
                {% if has_next %}
                <a href="{{ url_for('books_page', page=page+1, status=filter) }}"
                    class="btn btn-sm btn-outline-secondary">Next ‚Üí</a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
    const searchInput = document.getElementById('searchInput');
    const departmentFilter = document.getElementById('departmentFilter');
    const statusFilter = document.getElementById('statusFilter');
    const rows = document.querySelectorAll('.book-row');

    const noResultsRow = document.getElementById('noResults');

    function filterBooks() {
        const term = searchInput.value.toLowerCase();
        const dept = departmentFilter.value;
        const status = statusFilter.value;
        let visibleCount = 0;

        rows.forEach(row => {
            const title = row.querySelector('.book-title').textContent.toLowerCase();
            const author = row.querySelector('.book-author').textContent.toLowerCase();
            const id = row.cells[0].textContent.toLowerCase();
            const rowDept = row.dataset.dept;
            const rowStatus = row.dataset.status;

            const matchesSearch = title.includes(term) || author.includes(term) || id.includes(term);
            const matchesDept = dept === "" || rowDept === dept;
            const matchesStatus = status === "" || rowStatus === status;

            if (matchesSearch && matchesDept && matchesStatus) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });
        noResultsRow.style.display = visibleCount === 0 ? '' : 'none';
    }

    searchInput.addEventListener('input', filterBooks);
    departmentFilter.addEventListener('change', filterBooks);
    statusFilter.addEventListener('change', filterBooks);
</script>
{% endblock %}